<!DOCTYPE html>
<html>
<link rel="icon" href="data:,">

<head>
  <meta charset="UTF-8">
  <title>21 Game</title>
</head>

<body>

  <h2>Participantes</h2>

  <input id="txtName" placeholder="Nombre" />
  <button onclick="addPlayer()">Agregar</button>

  <p><b>Lista:</b></p>
  <ul id="listPlayers"></ul>

  <hr>

  <h2>Registrar Ronda</h2>

  Monto: <input id="txtMonto" type="number" value="500" />
  <br><br>

  Ganador:
  <select id="selWinner"></select>

  <br><br>
  <button onclick="addRound()">Registrar Ronda</button>

  <hr>
  <h3>Resumen Contable en Vivo</h3>
  <pre id="liveResume"></pre>


  <h2>Resumen final</h2>
  <button onclick="finalize()">Finalizar y mover a hist√≥rico</button>

  <pre id="resultado"></pre>

  <script>
    async function loadPlayers() {
      const res = await fetch("/api/players");
      const players = await res.json();
      const list = document.getElementById("listPlayers");
      const sel = document.getElementById("selWinner");

      list.innerHTML = "";
      sel.innerHTML = "";

      players.forEach(p => {
        const li = document.createElement("li");

        li.innerHTML = `
      ${p}
      <button onclick="deletePlayer('${p}')">‚ùå</button>
    `;

        list.appendChild(li);

        // üü¢ llenar select
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
      });
    }


    async function addPlayer() {
      const name = document.getElementById("txtName").value.trim();
      if (!name) return alert('Escribe un nombre');;

      await fetch("/api/players", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });

      document.getElementById("txtName").value = "";
      await loadPlayers();
      await loadResumen();
    }
    async function deletePlayer(name) {
      if (!confirm('Eliminar ' + name + '?')) return;
      await fetch('/api/players/' + encodeURIComponent(name), { method: 'DELETE' });
      await loadPlayers();
      await loadResumen();
    }
    async function addRound() {
      const amount = parseInt(document.getElementById("txtMonto").value);
      const winner = document.getElementById("selWinner").value;
      if (!winner) return alert('Selecciona ganador');
      await fetch("/api/rounds", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount, winner })
      });

      //alert("Ronda registrada");

      // üëâ ACTUALIZAR RESUMEN EN VIVO
      await loadResumen();
    }

    async function loadResumen() {
      const res = await fetch('/api/resumen');
      const cuentas = await res.json();
      let txt = '';
      for (const p in cuentas) txt += `${p}: ${cuentas[p]}\n`;
      document.getElementById('liveResume').textContent = txt;
    }
    async function finalize() {
      if (!confirm('¬øFinalizar y mover a hist√≥rico?')) return;
      const res = await fetch('/api/finalize', { method: 'POST' });
      const data = await res.json();
      document.getElementById('resultado').textContent = JSON.stringify(data, null, 2);
      await loadPlayers();
      await loadResumen();
    } 

    loadPlayers();
    loadResumen();
  </script>

</body>

</html>